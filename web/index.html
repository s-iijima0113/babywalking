<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お散歩アプリ</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css" rel="stylesheet" />
    <!-- <script src="https://unpkg.com/@mapbox/mapbox-gl-language/dist/mapbox-gl-language.js"></script> -->
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v1.0.0/mapbox-gl-language.js'></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css"
        type="text/css" />

    <h1>Walking With Baby</h1>
    <p>Enjoy your preciaus moment with baby!!</p>
    <!-- <script src="/static/js/app.js"></script> -->
    
    <div id="map"></div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2F0b21paWkiLCJhIjoiY21kemViendyMGIzdzJrb2ltODFqZzdiZCJ9.oida2Ztmk9t7Gu7JQt1Qsw';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [139.647238, 35.86236], //自宅
            zoom: 15
        });

        //facilitiedAPI取得
        let allFacilities = [];
        let markers = [];

        function loadFacilities() {
            fetch('/api/facilities')
                .then(res => res.json())
                .then(data => {
                    allFacilities = data;
                    updateMarkers();
                });
        }

        function updateMarkers() {
            // 古いマーカー削除
            markers.forEach(m => m.remove());
            markers = [];

            const showToilet = document.getElementById('toilet').checked;
            const showNursing = document.getElementById('nursing').checked;

            allFacilities.forEach(facility => {
                if (
                    (facility.toilet.includes(true) && showToilet) ||
                    (facility.nursing.includes(true) && showNursing)
                ) {
                    const el = document.createElement('div');
                    el.style.width = '30px';
                    el.style.height = '30px';
                    el.style.backgroundSize = 'cover';

                    if (facility.toilet.includes(true) && facility.nursing.includes(true)) {
                    // 両方持つ施設ならアイコンを横に並べる
                    el.style.display = "flex";
                    el.innerHTML = `
                    <img src="./icon/toilet.png" style="width:15px;height:15px;">
                    <img src="./icon/nursing.png" style="width:15px;height:15px;">
                    `;
                    } else if (facility.toilet.includes(true)) {
                        el.style.backgroundImage = 'url(./icon/toilet.png)';
                    } else if (facility.nursing.includes(true)) {
                        el.style.backgroundImage = 'url(./icon/nursing.png)';
                    }

                    const marker = new mapboxgl.Marker(el)
                        .setLngLat([facility.lon, facility.lat])
                        .setPopup(new mapboxgl.Popup().setText(facility.name))
                        .addTo(map);

                    markers.push(marker);
                }
            });
        }

        // チェックボックスにイベント追加
        document.addEventListener("DOMContentLoaded", () => {
        document.getElementById('toilet').addEventListener('change', updateMarkers);
        document.getElementById('nursing').addEventListener('change', updateMarkers);
        });
        // 初回ロード
        loadFacilities();
        //   map.addControl(
        //         new MapboxDirections({
        //             accessToken: mapboxgl.accessToken
        //         })
        //     );

        map.addControl(
            new MapboxDirections({
                accessToken: mapboxgl.accessToken
            }),
            'top-left'
        );
        // map.addControl(
        //         new MapboxGeocoder({
        //             accessToken: mapboxgl.accessToken,
        //             mapboxgl: mapboxgl
        //         })
        //     );
            
        // 言語設定を日本語に変更
        map.addControl(new MapboxLanguage({ defaultLanguage: 'ja' }));
    </script>
    <form method="POST" action="/search">
        <div class="form-section">
            <strong>Feel:</strong>
            <label>
                <input type="checkbox" name="feel" value="meet-up">
                meet-up
            </label>
            <label>
                <input type="checkbox" name="feel" value="cafe">
                cafe
            </label>
            <label>
                <input type="checkbox" name="feel" value="nature">
                nature
            </label>
            <label>
                <input type="checkbox" name="feel" value="shopping">
                shopping
            </label>
        </div>
        <div class="form-section">
            <strong>others:</strong>
            <label>
                <input type="checkbox" id="toilet" name="facility" value="toilet">
                baby toilets
            </label>
            <label>
                <input type="checkbox" id="nursing" name="facility" value="nursing">
                nursing room
            </label>
            <label>
                <input type="checkbox" id="saicoin" name="facility" value="saicoin">
                Saicoin
            </label>
            <label>
                <input type="checkbox" id="tamapon" name="facility" value="tamapon">
                Tamapon
            </label>
        </div>
        <div class="form-section">
            <strong>Walking Time (minutes):</strong>
            <input type="range" name="walkTime" min="20" max="60" step="10"
                oninput="this.nextElementSibling.value = this.value">
            <output>30</output> minutes
        </div>
        <div class="form-section">
            <strong>options:</strong>
            <label>
                <input type="checkbox" name="shade" value="shade">
                shade
            </label>
        </div>
        <br>
        <button type="submit">送信</button>
    </form>
</body>
</html>
